<?xml version="1.0" encoding="us-ascii"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://www.microsoft.com/2011/12/aaptperffun#1">

  <metadata testName ="Stress" teamName ="SignalR" description="SignalR Stress Tests">
  </metadata>

  <commands>
    <command name="SendReceive-LongPolling" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:SendReceive /Transport:LongPolling /Senders:5
    </command>
    <command name="SendReceive-ServerSentEvents" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:SendReceive /Transport:ServerSentEvents /Senders:5
    </command>
    <command name="HubInvocation" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:HubInvocation /Senders:5
    </command>
    <command name="SimpleEchoHub-LongPolling" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:SimpleEchoHub /Host:HttpListener /Transport:LongPolling /Senders:5 /Connections:5
    </command>
    <command name="SimpleEchoHub-ServerSentEvents" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:SimpleEchoHub /Host:HttpListener /Transport:ServerSentEvents /Senders:5 /Connections:5
    </command>
    <command name="MessageBus" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:MessageBus /Senders:5
    </command>
    <command name="SetupSqlServer" wait="Exit">
      sqlcmd -i CreateStressDatabase.sql
    </command>
    <command name="SqlMessageBus" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:SqlMessageBus /Senders:5 /SqlConnectionString:"Data Source={dbserver-01};Initial Catalog=Stress;User ID=sqluser;Password={remotePassword}"
    </command>
    <command name="RedisMessageBus" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:RedisMessageBus /Senders:5 /RedisServer:{dbserver-01} /RedisPort:6379
    </command>

    <!-- External host-->
    <command name="SetupIIS" wait="Exit">
      powershell -executionpolicy bypass -command "{bin}\RegisterIIS.ps1 {currentdir}\www"
    </command>
    <command name="SimpleEchoHub-External-LongPolling" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:SimpleEchoHub /Transport:LongPolling /Senders:5 /Connections:5 /Host:External /Url:http://{server-01}:81
    </command>
    <command name="SimpleEchoHub-External-ServerSentEvents" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:SimpleEchoHub /Transport:ServerSentEvents /Senders:5 /Connections:5 /Host:External /Url:http://{server-01}:81
    </command>
    <command name="SimpleEchoHub-External-WebSockets" wait="Exit">
      Microsoft.AspNet.SignalR.Stress.exe /Run:SimpleEchoHub /Transport:WebSockets /Senders:5 /Connections:5 /Host:External /Url:http://{server-01}:81
    </command>

  </commands>

  <plan>
    <run command="SendReceive-LongPolling" role="server-01" output="true" measure="StartAndStop" />
    <run command="SendReceive-ServerSentEvents" role="server-01" output="true" measure="StartAndStop" />

    <run command="HubInvocation" role="server-01" output="true" measure="StartAndStop" />

    <!-- End to end hub invocation tests -->
    <run command="SimpleEchoHub-LongPolling" role="server-01" output="true" measure="StartAndStop" />
    <run command="SimpleEchoHub-ServerSentEvents" role="server-01" output="true" measure="StartAndStop" />

    <!--Message bus tests -->
    <run command="MessageBus" role="server-01" output="true" measure="StartAndStop" />

    <run command="SetupSqlServer" role="dbserver-01" output="true" />
    <run command="SqlMessageBus" role="server-01" output="true" measure="StartAndStop" />
    
    <run command="RedisMessageBus" role="server-01" output="true" measure="StartAndStop" />

    <!--External host hub tests-->
    <run command="SetupIIS" role="server-01" output="true" />
    <run command="SimpleEchoHub-External-LongPolling" role="client-01" output="true" measure="StartAndStop" />
    
    <run command="SetupIIS" role="server-01" output="true" />
    <run command="SimpleEchoHub-External-ServerSentEvents" role="client-01" output="true" measure="StartAndStop" />
    
    <run command="SetupIIS" role="server-01" output="true" />
    <run command="SimpleEchoHub-External-WebSockets" role="client-01" output="true" measure="StartAndStop" />
  </plan>
</config>
