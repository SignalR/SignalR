/*!
* SignalR JavaScript Library v0.5
* http://signalr.net/
*
* Copyright David Fowler and Damian Edwards 2012
* Licensed under the MIT.
* https://github.com/SignalR/SignalR/blob/master/LICENSE.md
*/
(function(n,t){"use strict";function o(i){var r;return(i=n.trim(i),i.indexOf("http")!==0)?!1:(r=t.document.createElement("a"),r.href=i,r.protocol+r.host!==t.location.protocol+t.location.host)}var u;if(typeof n!="function")throw"SignalR: jQuery not found. Please ensure jQuery is referenced before the SignalR.js file.";if(!t.JSON)throw"SignalR: No JSON parser found. Please ensure json2.js is referenced before the SignalR.js file if you need to support clients without native JSON parsing support, e.g. IE<8.";var i,e,r={onStart:"onStart",onStarting:"onStarting",onSending:"onSending",onReceived:"onReceived",onError:"onError",onReconnect:"onReconnect",onStateChanged:"onStateChanged",onDisconnect:"onDisconnect"},s=function(n,i){if(i!==!1){var r;typeof t.console!="undefined"&&(r="["+(new Date).toTimeString()+"] SignalR: "+n,t.console.debug?t.console.debug(r):t.console.log&&t.console.log(r))}},f=function(t,i){i!==t.state&&(n(t).trigger(r.onStateChanged,[i]),t.state=i)};i=function(n,t,r){return new i.fn.init(n,t,r)},i.connectionState={connecting:0,connected:1,reconnecting:2,disconnecting:3,disconnected:4},i.fn=i.prototype={init:function(n,t,i){this.url=n,this.qs=t,typeof i=="boolean"&&(this.logging=i)},ajaxDataType:"json",logging:!1,state:i.connectionState.disconnected,reconnectDelay:2e3,start:function(u,e){var s=this,h={transport:"auto",jsonp:!1},a,c=n.Deferred(),l=document.createElement("a");return s.state===i.connectionState.connecting||s.state===i.connectionState.connected?(c.resolve(s),c.promise()):(f(s,i.connectionState.connecting),n.type(u)==="function"?e=u:n.type(u)==="object"&&(n.extend(h,u),n.type(h.callback)==="function"&&(e=h.callback)),l.href=s.url,s.baseUrl=l.protocol===":"?t.document.location.protocol+"//"+t.document.location.host:l.protocol+"//"+l.host,o(s.url)&&(s.log("Auto detected cross domain url."),h.transport==="auto"&&(h.jsonp||(h.jsonp=!n.support.cors,h.jsonp&&s.log("Using jsonp because this browser doesn't support cors")),h.transport=h.jsonp===!0?"longPolling":["webSockets","longPolling"])),s.ajaxDataType=h.jsonp?"jsonp":"json",n(s).bind(r.onStart,function(){n.type(e)==="function"&&e.call(s),c.resolve(s)}),a=function(u,e){if(e=e||0,e>=u.length){s.transport||c.reject("SignalR: No transport could be initialized successfully. Try specifying a different transport or none at all for auto initialization.");return}var o=u[e],h=n.type(o)==="object"?o:i.transports[o];h.start(s,function(){s.transport=h,n(s).trigger(r.onStart),f(s,i.connectionState.connected),n(t).unload(function(){s.stop(!1)})},function(){a(u,e+1)})},t.setTimeout(function(){var t=s.url+"/negotiate";s.log("Negotiating with '"+t+"'."),n.ajax({url:t,global:!1,cache:!1,type:"GET",data:{},dataType:s.ajaxDataType,error:function(t){n(s).trigger(r.onError,[t.responseText]),c.reject("SignalR: Error during negotiation request: "+t),s.stop()},success:function(t){if(s.appRelativeUrl=t.Url,s.id=t.ConnectionId,s.webSocketServerUrl=t.WebSocketServerUrl,!t.ProtocolVersion||t.ProtocolVersion!=="1.0"){n(s).trigger(r.onError,"SignalR: Incompatible protocol version."),c.reject("SignalR: Incompatible protocol version.");return}n(s).trigger(r.onStarting);var f=[],u=[];n.each(i.transports,function(n){if(n==="webSockets"&&!t.TryWebSockets)return!0;u.push(n)}),n.isArray(h.transport)?n.each(h.transport,function(){var t=this;(n.type(t)==="object"||n.type(t)==="string"&&n.inArray(""+t,u)>=0)&&f.push(n.type(t)==="string"?""+t:t)}):n.type(h.transport)==="object"||n.inArray(h.transport,u)>=0?f.push(h.transport):f=u,a(f)}})},0),c.promise())},starting:function(t){var i=this,u=n(i);return u.bind(r.onStarting,function(){t.call(i),u.unbind(r.onStarting)}),i},send:function(n){var t=this;if(!t.transport)throw"SignalR: Connection must be started before data can be sent. Call .start() before .send()";return t.transport.send(t,n),t},sending:function(t){var i=this;return n(i).bind(r.onSending,function(){t.call(i)}),i},received:function(t){var i=this;return n(i).bind(r.onReceived,function(n,r){t.call(i,r)}),i},stateChanged:function(t){var i=this;return n(i).bind(r.onStateChanged,function(n,r){t.call(i,r)}),i},error:function(t){var i=this;return n(i).bind(r.onError,function(n,r){t.call(i,r)}),i},disconnected:function(t){var i=this;return n(i).bind(r.onDisconnect,function(){t.call(i)}),i},reconnected:function(t){var i=this;return n(i).bind(r.onReconnect,function(){t.call(i)}),i},stop:function(t){var u=this;if(u.state!==i.connectionState.disconnecting&&u.state!==i.connectionState.disconnected){try{f(u,i.connectionState.disconnecting),u.transport&&(u.transport.abort(u,t),u.transport.stop(u),u.transport=null),n(u).trigger(r.onDisconnect),delete u.messageId,delete u.groups}finally{f(u,i.connectionState.disconnected)}return u}},log:function(n){s(n,this.logging)}},i.fn.init.prototype=i.fn,u={addQs:function(i,r){return r.qs?typeof r.qs=="object"?i+"&"+n.param(r.qs):typeof r.qs=="string"?i+"&"+r.qs:i+"&"+t.escape(r.qs.toString()):i},getUrl:function(n,i,r,u){var o=i==="webSockets"?"":n.baseUrl,f=o+n.appRelativeUrl,e="transport="+i+"&connectionId="+t.escape(n.id);return n.data&&(e+="&connectionData="+t.escape(n.data)),r?(u&&(f=f+"/reconnect"),n.messageId&&(e+="&messageId="+n.messageId),n.groups&&(e+="&groups="+t.escape(JSON.stringify(n.groups)))):f=f+"/connect",f+="?"+e,f=this.addQs(f,n)},ajaxSend:function(i,u){var f=i.url+"/send?transport="+i.transport.name+"&connectionId="+t.escape(i.id);f=this.addQs(f,i),n.ajax({url:f,global:!1,type:"POST",dataType:i.ajaxDataType,data:{data:u},success:function(t){t&&n(i).trigger(r.onReceived,[t])},error:function(t,u){u!=="abort"&&(u!=="parsererror"||i.ajaxDataType!=="jsonp")&&n(i).trigger(r.onError,[t])}})},ajaxAbort:function(i,r){if(typeof i.transport!="undefined"){r=typeof r=="undefined"?!0:r;var u=i.url+"/abort?transport="+i.transport.name+"&connectionId="+t.escape(i.id);u=this.addQs(u,i),n.ajax({url:u,async:r,timeout:1e3,global:!1,type:"POST",dataType:i.ajaxDataType,data:{}}),i.log("Fired ajax abort async = "+r)}},processMessages:function(t,i){var u=n(t);if(i){if(i.Disconnect){t.log("Disconnect command received from server"),t.stop();return}i.Messages&&n.each(i.Messages,function(){try{u.trigger(r.onReceived,[this])}catch(i){t.log("Error raising received "+i),n(t).trigger(r.onError,[i])}}),i.MessageId&&(t.messageId=i.MessageId),i.TransportData&&(t.groups=i.TransportData.Groups)}},foreverFrame:{count:0,connections:{}}},i.transports={webSockets:{name:"webSockets",send:function(n,t){n.socket.send(t)},start:function(e,o,s){var c,a=!1,v=this,y=!o,l,h;if(t.MozWebSocket&&(t.WebSocket=t.MozWebSocket),!t.WebSocket){s();return}e.socket||(e.webSocketServerUrl?c=e.webSocketServerUrl:(h=document.location,h.protocol!=="http:"&&h.protocol!=="https:"&&(h=t.document.createElement("a"),h.href=e.url),l=h.protocol==="https:"?"wss://":"ws://",c=l+h.host),n(e).trigger(r.onSending),c+=u.getUrl(e,this.name,y),e.log("Connecting to websocket endpoint '"+c+"'"),e.socket=new t.WebSocket(c),e.socket.onopen=function(){a=!0,e.log("Websocket opened"),o?o():f(e,i.connectionState.connected)},e.socket.onclose=function(t){a?typeof t.wasClean!="undefined"&&t.wasClean===!1?(n(e).trigger(r.onError,[t.reason]),e.log("Unclean disconnect from websocket."+t.reason)):e.log("Websocket closed"):s&&s(),f(e,i.connectionState.reconnecting),v.stop(e),v.start(e)},e.socket.onmessage=function(i){var f=t.JSON.parse(i.data),o;f&&(o=n(e),f.Messages?u.processMessages(e,f):o.trigger(r.onReceived,[f]))})},stop:function(n){n.socket!==null&&(n.socket.close(),n.socket=null)},abort:function(){}},serverSentEvents:{name:"serverSentEvents",timeOut:3e3,start:function(e,o,s){var h=this,a=!1,l=n(e),c=!o,y,v;if(e.eventSource&&(e.log("The connection already has an event source. Stopping it."),e.stop()),!t.EventSource){s&&(e.log("This browser doesn't support SSE."),s());return}l.trigger(r.onSending),y=u.getUrl(e,this.name,c);try{e.log("Attempting to connect to SSE endpoint '"+y+"'"),e.eventSource=new t.EventSource(y)}catch(p){e.log("EventSource failed trying to connect with error "+p.Message),s?s():(l.trigger(r.onError,[p]),c&&(e.log("EventSource reconnecting"),h.reconnect(e)));return}v=t.setTimeout(function(){a===!1&&(e.log("EventSource timed out trying to connect"),s&&s(),c?(e.log("EventSource reconnecting"),h.reconnect(e)):(e.log("EventSource stopping the connection."),h.stop(e)))},h.timeOut),e.eventSource.addEventListener("open",function(){e.log("EventSource connected"),v&&t.clearTimeout(v),a===!1&&(a=!0,o&&o(),c&&(l.trigger(r.onReconnect),f(e,i.connectionState.connected)))},!1),e.eventSource.addEventListener("message",function(n){n.data!=="initialized"&&u.processMessages(e,t.JSON.parse(n.data))},!1),e.eventSource.addEventListener("error",function(n){if(!a){s&&s();return}e.log("EventSource readyState: "+e.eventSource.readyState),n.eventPhase===t.EventSource.CLOSED?e.eventSource.readyState===t.EventSource.CONNECTING?(e.log("EventSource reconnecting due to the server connection ending"),f(e,i.connectionState.reconnecting),h.reconnect(e)):(e.log("EventSource closed"),h.stop(e)):(e.log("EventSource error"),l.trigger(r.onError))},!1)},reconnect:function(n){var i=this;t.setTimeout(function(){i.stop(n),i.start(n)},n.reconnectDelay)},send:function(n,t){u.ajaxSend(n,t)},stop:function(n){n&&n.eventSource&&(n.eventSource.close(),n.eventSource=null,delete n.eventSource)},abort:function(n,t){u.ajaxAbort(n,t)}},foreverFrame:{name:"foreverFrame",timeOut:3e3,start:function(e,o,s){var c=this,l=u.foreverFrame.count+=1,a,v,h=n("<iframe data-signalr-connection-id='"+e.id+"' style='position:absolute;top:0;left:0;width:0;height:0;visibility:hidden;'></iframe>");if(t.EventSource){s&&(e.log("This brower supports SSE, skipping Forever Frame."),s());return}n(e).trigger(r.onSending),a=u.getUrl(e,this.name),a+="&frameId="+l,h.prop("src",a),u.foreverFrame.connections[l]=e,e.log("Binding to iframe's readystatechange event."),h.bind("readystatechange",function(){n.inArray(this.readyState,["loaded","complete"])>=0&&(e.log("Forever frame iframe readyState changed to "+this.readyState+", reconnecting"),f(e,i.connectionState.reconnecting),c.reconnect(e))}),e.frame=h[0],e.frameId=l,o&&(e.onSuccess=o),n("body").append(h),v=t.setTimeout(function(){e.onSuccess&&(e.log("Failed to connect using forever frame source, it timed out after "+c.timeOut+"ms."),c.stop(e),s&&s())},c.timeOut)},reconnect:function(n){var i=this;t.setTimeout(function(){var r=n.frame,t=u.getUrl(n,i.name,!0)+"&frameId="+n.frameId;n.log("Upating iframe src to '"+t+"'."),r.src=t},n.reconnectDelay)},send:function(n,t){u.ajaxSend(n,t)},receive:u.processMessages,stop:function(t){t.frame&&(t.frame.stop?t.frame.stop():t.frame.document&&t.frame.document.execCommand&&t.frame.document.execCommand("Stop"),n(t.frame).remove(),delete u.foreverFrame.connections[t.frameId],t.frame=null,t.frameId=null,delete t.frame,delete t.frameId,t.log("Stopping forever frame"))},abort:function(n,t){u.ajaxAbort(n,t)},getConnection:function(n){return u.foreverFrame.connections[n]},started:function(t){t.onSuccess?(t.onSuccess(),t.onSuccess=null,delete t.onSuccess):(n(t).trigger(r.onReconnect),f(t,i.connectionState.connected))}},longPolling:{name:"longPolling",reconnectDelay:3e3,start:function(e,o){var c=this,h=!1;e.pollXhr&&(e.log("Polling xhr requests already exists, aborting."),e.stop()),e.messageId=null,t.setTimeout(function(){(function s(l,a){n(l).trigger(r.onSending);var k=l.messageId,b=k===null,w=!b,p=u.getUrl(l,c.name,w,a),y=null,v=!1;w===!0&&a===!0&&f(e,i.connectionState.reconnecting),e.log("Attempting to connect to '"+p+"' using longPolling."),l.pollXhr=n.ajax({url:p,global:!1,type:"GET",dataType:e.ajaxDataType,success:function(c){var p=0,y=!1;(h==!1&&(o(),h=!0),a===!0&&v===!1&&(e.log("Raising the reconnect event"),f(e,i.connectionState.connected),n(l).trigger(r.onReconnect),v=!0),u.processMessages(l,c),c&&c.TransportData&&n.type(c.TransportData.LongPollDelay)==="number"&&(p=c.TransportData.LongPollDelay),c&&c.TimedOut&&(y=c.TimedOut),c&&c.Disconnect)||(p>0?t.setTimeout(function(){s(l,y)},p):s(l,y))},error:function(i,u){if(u==="abort"){e.log("Aborted xhr requst.");return}e.log("An error occurred using longPolling. Status = "+u+". "+i.responseText),y&&clearTimeout(y),n(l).trigger(r.onError,[i.responseText]),t.setTimeout(function(){s(l,!0)},e.reconnectDelay)}}),a===!0&&(y=t.setTimeout(function(){v===!1&&(f(e,i.connectionState.connected),n(l).trigger(r.onReconnect),v=!0)},c.reconnectDelay))})(e),t.setTimeout(function(){h===!1&&(o(),h=!0)},150)},250)},send:function(n,t){u.ajaxSend(n,t)},stop:function(n){n.pollXhr&&(n.pollXhr.abort(),n.pollXhr=null,delete n.pollXhr)},abort:function(n,t){u.ajaxAbort(n,t)}}},i.noConflict=function(){return n.connection===i&&(n.connection=e),i},n.connection&&(e=n.connection),n.connection=n.signalR=i})(window.jQuery,window)